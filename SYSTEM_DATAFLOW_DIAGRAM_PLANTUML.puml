@startuml Dental_Clinic_Data_Flow_Diagram
!theme plain
skinparam backgroundColor #fafafa
skinparam linetype ortho
skinparam shadowing true

title Dental Clinic System - Data Flow Diagram\n(Key Workflows)

' ============================================
' WORKFLOW 1: APPOINTMENT BOOKING
' ============================================

package "WORKFLOW 1: APPOINTMENT BOOKING FLOW" #FFE4E4 {
    
    rectangle "Patient User" as patient_booking
    rectangle "Website Frontend\n(/book)" as booking_ui
    rectangle "AppointmentController\n::store()" as booking_controller
    rectangle "Appointment Model" as apt_model_booking
    rectangle "Service Model" as service_model_booking
    rectangle "Dentist Model" as dentist_model_booking
    rectangle "Database" as db_booking
    rectangle "Email Service" as email_booking
    rectangle "WhatsApp Service" as whatsapp_booking
    rectangle "ActivityLogger" as log_booking
    
    patient_booking --> booking_ui : enters details
    booking_ui --> booking_controller : validates &\nsubmits
    booking_controller --> apt_model_booking : creates
    booking_controller --> service_model_booking : validates\navailability
    booking_controller --> dentist_model_booking : checks\nschedule
    apt_model_booking --> db_booking : saves\nappointment
    booking_controller --> email_booking : sends confirmation
    booking_controller --> whatsapp_booking : sends reminder
    booking_controller --> log_booking : logs booking event
    
    note right of log_booking
        Records: who, when, what
        Appointment created with
        visit_token & visit_code
    end note
}

' ============================================
' WORKFLOW 2: PATIENT CHECK-IN & QUEUE
' ============================================

package "WORKFLOW 2: PATIENT CHECK-IN & QUEUE ASSIGNMENT" #E4E4FF {
    
    rectangle "Patient/Staff" as patient_checkin
    rectangle "Check-In Endpoint\n(/api/check-in)" as checkin_endpoint
    rectangle "CheckInService\n::checkIn()" as checkin_service
    rectangle "Appointment Model\n(validation)" as apt_validation
    rectangle "Queue Model" as queue_model
    rectangle "QueueAssignmentService\n::assignNextPatient()" as queue_assign
    rectangle "Dentist Model" as dentist_model
    rectangle "Room Model" as room_model
    rectangle "Database" as db_queue
    rectangle "ActivityLogger\n(audit trail)" as log_queue
    
    patient_checkin --> checkin_endpoint : check-in request\n(token/code)
    checkin_endpoint --> checkin_service : validate &\ncheck in
    checkin_service --> apt_validation : verify\nappointment
    checkin_service --> queue_model : create queue\nrecord
    queue_model --> db_queue : save with\nstatus='waiting'
    queue_model --> queue_assign : trigger\nassignment
    queue_assign --> room_model : find available\nroom
    queue_assign --> dentist_model : find available\ndentist
    queue_assign --> queue_model : assign room\n& dentist
    queue_model --> db_queue : update with\nassignments
    queue_assign --> log_queue : log assignment
    
    note right of queue_assign
        Core Logic:
        - Shortest queue
        - Available dentist
        - Room availability
        - Workload balance
    end note
}

' ============================================
' WORKFLOW 3: STAFF QUEUE MANAGEMENT
' ============================================

package "WORKFLOW 3: STAFF QUEUE MANAGEMENT" #E4FFE4 {
    
    rectangle "Clinic Staff" as staff_queue
    rectangle "Queue Dashboard\n(/staff/appointments)" as queue_dashboard
    rectangle "StaffAppointmentController" as staff_apt_controller
    rectangle "QueueAssignmentService\n(core service)" as queue_service
    rectangle "Queue Model" as queue_model_staff
    rectangle "Appointment Model" as apt_model_staff
    rectangle "Database" as db_staff
    rectangle "ActivityLogger" as log_staff
    
    staff_queue --> queue_dashboard : views queue
    queue_dashboard --> staff_apt_controller : calls actions
    
    note over staff_apt_controller
        Actions:
        - Call next patient
        - Mark in-service
        - Mark completed
        - Manual reorder
    end note
    
    staff_apt_controller --> queue_service : update status
    queue_service --> queue_model_staff : modify
    queue_service --> apt_model_staff : update appointment
    queue_model_staff --> db_staff : persist changes
    queue_service --> log_staff : audit trail
    
    note right of queue_service
        Status Transitions:
        waiting → called
        called → in_service
        in_service → completed
    end note
}

' ============================================
' WORKFLOW 4: AUTOMATED LATE/NO-SHOW
' ============================================

package "WORKFLOW 4: AUTOMATED LATE/NO-SHOW DETECTION" #FFE4F0 {
    
    rectangle "System Scheduler\n(cron/queue)" as scheduler
    rectangle "LateNoShowService\n::markLateAppointments()" as late_service
    rectangle "LateNoShowService\n::markNoShowAppointments()" as noshow_service
    rectangle "Queue Model" as queue_model_late
    rectangle "Appointment Model" as apt_model_late
    rectangle "Database" as db_late
    rectangle "ActivityLogger" as log_late
    
    scheduler --> late_service : trigger\nevery N mins
    late_service --> queue_model_late : query unpicked\nappointments
    queue_model_late --> db_late : find records where\ncheck_in_time >\nappt_time + 15 mins
    late_service --> apt_model_late : update status\nto 'late'
    late_service --> log_late : log status change
    
    scheduler --> noshow_service : trigger\nevery N mins
    noshow_service --> queue_model_late : query\nappointments
    queue_model_late --> db_late : find records where\nappt_time + 30 mins\n< current_time
    noshow_service --> apt_model_late : update status\nto 'no_show'
    noshow_service --> log_late : log status change
    
    note right of late_service
        Late: arrival > 15 mins
        after appointment time
    end note
    
    note right of noshow_service
        No-Show: no check-in
        after 30 mins past appt time
    end note
}

' ============================================
' WORKFLOW 5: PATIENT STATUS TRACKING
' ============================================

package "WORKFLOW 5: PATIENT STATUS TRACKING" #F0F0FF {
    
    rectangle "Patient User" as patient_track
    rectangle "Track Endpoint\n(/visit/{token})" as track_endpoint
    rectangle "AppointmentController\n::visitStatus()" as track_controller
    rectangle "Appointment Model" as apt_model_track
    rectangle "Queue Model" as queue_model_track
    rectangle "Database" as db_track
    rectangle "Response to Client" as track_response
    
    patient_track --> track_endpoint : request status\n(visit token/code)
    track_endpoint --> track_controller : fetch appointment
    track_controller --> apt_model_track : find by token
    apt_model_track --> db_track : query database
    track_controller --> queue_model_track : get queue info
    queue_model_track --> db_track : query queue status
    track_controller --> track_response : return JSON with:\nstatus\nqueue position\nestimated wait time
    track_response --> patient_track : display status
    
    note right of track_response
        Real-time Data:
        - Current status
        - Position in queue
        - Est. wait time
        - Dentist assigned
    end note
}

' ============================================
' WORKFLOW 6: STAFF MANAGEMENT FLOW
' ============================================

package "WORKFLOW 6: RESOURCE MANAGEMENT FLOW" #F0FFE4 {
    
    rectangle "Clinic Manager" as manager
    rectangle "Management Pages\n(/staff/dentists, /staff/services)" as mgmt_ui
    rectangle "Resource Controllers\n(Dentist, Service, Room)" as resource_controller
    rectangle "Model Layer" as resource_models
    rectangle "Database" as db_resource
    rectangle "ActivityLogger\n(audit trail)" as log_resource
    
    manager --> mgmt_ui : CRUD operations
    mgmt_ui --> resource_controller : create/update/delete
    resource_controller --> resource_models : validate data
    resource_models --> db_resource : persist changes
    resource_controller --> log_resource : log all changes\n(before/after values)
    
    note right of log_resource
        Audit Trail Captures:
        - Who made change
        - When (timestamp)
        - What changed
        - Old vs New values
        - IP address
    end note
}

' ============================================
' CROSS-CUTTING DATA FLOW
' ============================================

package "CROSS-CUTTING DATA FLOWS" #F5F5F5 {
    
    rectangle "Any Controller Action" as any_controller
    rectangle "ActivityLogger\n::log()" as activity_logger_flow
    rectangle "ActivityLog Model" as log_model
    rectangle "Database\n(activity_logs table)" as db_logs
    
    any_controller --> activity_logger_flow : logs on\nCRUD operations
    activity_logger_flow --> log_model : creates record
    log_model --> db_logs : persists audit trail
    
    note right of activity_logger_flow
        Logged for:
        - Appointment changes
        - Queue operations
        - Resource updates
        - User actions
    end note
}

' ============================================
' DATA MODEL RELATIONSHIPS
' ============================================

package "KEY DATA RELATIONSHIPS" #E8E8E8 {
    
    rectangle "Appointment" as data_apt
    rectangle "Queue" as data_queue
    rectangle "Dentist" as data_dentist
    rectangle "Service" as data_service
    rectangle "Room" as data_room
    rectangle "DentistSchedule" as data_schedule
    rectangle "Feedback" as data_feedback
    
    data_apt --> data_queue : 1:1 (hasOne)
    data_apt --> data_service : N:1 (belongsTo)
    data_apt --> data_dentist : N:1 (belongsTo)
    data_apt --> data_feedback : 1:M (hasMany)
    data_queue --> data_dentist : N:1 (belongsTo)
    data_queue --> data_room : N:1 (belongsTo)
    data_dentist --> data_schedule : 1:M (hasMany)
    data_dentist --> data_feedback : 1:M (hasMany)
    
    note bottom of data_queue
        Core data structure
        for queue management
        Stores: status, times,
        assignments, audit info
    end note
}

@enduml
